# 班级和学生班级功能详细文档

## 目录

1. [概述](#概述)
2. [数据库表结构](#数据库表结构)
3. [实体类说明](#实体类说明)
4. [功能模块](#功能模块)
   - [班级管理](#班级管理)
   - [学生班级关联](#学生班级关联)
   - [签到管理](#签到管理)
   - [课堂照片](#课堂照片)
   - [多班级课程](#多班级课程)
5. [API接口文档](#api接口文档)
   - [学生端接口](#学生端接口)
   - [教师端接口](#教师端接口)
   - [管理员接口](#管理员接口)
6. [业务流程](#业务流程)
7. [数据导入导出](#数据导入导出)
8. [注意事项](#注意事项)

---

## 概述

本系统实现了完整的班级管理功能，包括班级信息管理、学生与班级的关联、签到管理、课堂照片上传等核心功能。系统支持多班级课程配置，允许学生跨班签到，为教学管理提供了灵活的解决方案。

### 核心特性

- **班级管理**：支持班级的创建、查询、验证码生成
- **学生绑定**：学生可通过验证码绑定班级
- **智能签到**：支持本班签到和跨班签到，自动识别学生所属班级
- **课堂照片**：学生可上传课堂照片，教师可查看
- **多班级课程**：支持一个课程面向多个班级授课
- **数据统计**：提供签到率、学生统计等数据分析

---

## 数据库表结构

### 1. 班级表 (classes)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | BIGINT | 主键 | AUTO_INCREMENT |
| class_code | VARCHAR(20) | 班级编号 | UNIQUE, NOT NULL |
| class_name | VARCHAR(100) | 班级名称 | NOT NULL |
| verification_code | VARCHAR(10) | 验证码 | NOT NULL |
| student_count | INT | 班级人数 | DEFAULT 0 |
| create_time | DATETIME | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| update_time | DATETIME | 更新时间 | ON UPDATE CURRENT_TIMESTAMP |
| is_deleted | TINYINT | 是否删除 | DEFAULT 0 |

**索引**：
- `uk_class_code`: class_code 唯一索引

### 2. 学生班级关联表 (student_class_relations)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | BIGINT | 主键 | AUTO_INCREMENT |
| student_username | VARCHAR(50) | 学生用户名 | NOT NULL |
| class_code | VARCHAR(20) | 班级编号 | NOT NULL |
| bind_time | DATETIME | 绑定时间 | DEFAULT CURRENT_TIMESTAMP |
| is_deleted | TINYINT | 是否删除 | DEFAULT 0 |

**索引**：
- `uk_student_class`: (student_username, class_code) 唯一索引

### 3. 课程表 (courses)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | BIGINT | 主键 | AUTO_INCREMENT |
| course_id | VARCHAR(20) | 课程ID | UNIQUE, NOT NULL |
| course_name | VARCHAR(200) | 课程名称 | NOT NULL |
| teacher_username | VARCHAR(50) | 授课老师用户名 | NOT NULL |
| class_code | VARCHAR(20) | 上课班级编号 | NOT NULL |
| location | VARCHAR(100) | 上课地点 | - |
| course_date | DATE | 课程日期 | NOT NULL |
| time_slot | VARCHAR(20) | 上课时间段 | NOT NULL |
| week_number | INT | 课程周次 | - |
| create_time | DATETIME | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| update_time | DATETIME | 更新时间 | ON UPDATE CURRENT_TIMESTAMP |
| is_deleted | TINYINT | 是否删除 | DEFAULT 0 |

### 4. 签到记录表 (attendance_records)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | BIGINT | 主键 | AUTO_INCREMENT |
| course_id | VARCHAR(20) | 课程ID | NOT NULL |
| student_username | VARCHAR(50) | 学生用户名 | NOT NULL |
| attendance_time | DATETIME | 签到时间 | NOT NULL |
| attendance_status | TINYINT | 签到状态 | DEFAULT 1 |
| ip_address | VARCHAR(50) | 签到IP地址 | - |
| create_time | DATETIME | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| update_time | DATETIME | 更新时间 | ON UPDATE CURRENT_TIMESTAMP |
| is_deleted | TINYINT | 是否删除 | DEFAULT 0 |

**索引**：
- `uk_course_student`: (course_id, student_username) 唯一索引

### 5. 课堂照片表 (class_photos)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | BIGINT | 主键 | AUTO_INCREMENT |
| course_id | VARCHAR(20) | 课程ID | NOT NULL |
| student_username | VARCHAR(50) | 学生用户名 | NOT NULL |
| photo_name | VARCHAR(200) | 照片文件名 | NOT NULL |
| photo_path | VARCHAR(500) | 照片存储路径 | NOT NULL |
| remark | TEXT | 照片备注 | - |
| file_size | BIGINT | 照片大小 | - |
| upload_time | DATETIME | 上传时间 | DEFAULT CURRENT_TIMESTAMP |
| create_time | DATETIME | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| update_time | DATETIME | 更新时间 | ON UPDATE CURRENT_TIMESTAMP |
| is_deleted | TINYINT | 是否删除 | DEFAULT 0 |

### 6. 多班级课程表 (multi_class_courses)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | BIGINT | 主键 | AUTO_INCREMENT |
| course_id | VARCHAR(20) | 课程ID | NOT NULL |
| class_code | VARCHAR(20) | 班级编号 | NOT NULL |
| teacher_username | VARCHAR(50) | 教师用户名 | NOT NULL |
| create_time | DATETIME | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| update_time | DATETIME | 更新时间 | ON UPDATE CURRENT_TIMESTAMP |

---

## 实体类说明

### 1. Class (班级实体)

**文件位置**: `src/main/java/com/signlab1/pojo/entity/Class.java`

```java
@Data
@AutoTable
@Table(value = "classes", comment = "班级表")
@TableName("classes")
@TableIndex(name = "uk_class_code", fields = {"classCode"}, type = IndexTypeEnum.UNIQUE)
public class Class {
    @TableId(type = IdType.AUTO)
    private Long id;                    // 班级ID
    
    @Column(comment = "班级编号", type = "varchar(20)", notNull = true)
    private String classCode;            // 班级编号
    
    @Column(comment = "班级名称", type = "varchar(100)", notNull = true)
    private String className;            // 班级名称
    
    @Column(comment = "验证码", type = "varchar(10)", notNull = true)
    private String verificationCode;     // 验证码（用于学生绑定班级）
    
    @Column(comment = "班级人数", type = "int", defaultValue = "0")
    private Integer studentCount;        // 班级人数
    
    @Column(comment = "创建时间", type = "datetime", defaultValue = "CURRENT_TIMESTAMP")
    private LocalDateTime createTime;    // 创建时间
    
    @Column(comment = "更新时间", type = "datetime", defaultValue = "CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP")
    private LocalDateTime updateTime;    // 更新时间
    
    @Column(comment = "是否删除", type = "tinyint", defaultValue = "0")
    private Integer isDeleted;          // 是否删除
}
```

### 2. StudentClassRelation (学生班级关联实体)

**文件位置**: `src/main/java/com/signlab1/pojo/entity/StudentClassRelation.java`

```java
@Data
@AutoTable
@Table(value = "student_class_relations", comment = "学生班级关联表")
@TableName("student_class_relations")
@TableIndex(name = "uk_student_class", fields = {"studentUsername", "classCode"}, type = IndexTypeEnum.UNIQUE)
public class StudentClassRelation {
    @TableId(type = IdType.AUTO)
    private Long id;                    // 关联ID
    
    @Column(comment = "学生用户名", type = "varchar(50)", notNull = true)
    private String studentUsername;     // 学生用户名/学号
    
    @Column(comment = "班级编号", type = "varchar(20)", notNull = true)
    private String classCode;            // 班级编号
    
    @Column(comment = "绑定时间", type = "datetime", defaultValue = "CURRENT_TIMESTAMP")
    private LocalDateTime bindTime;      // 绑定时间
    
    @Column(comment = "是否删除", type = "tinyint", defaultValue = "0")
    private Integer isDeleted;          // 软删除标记
}
```

### 3. ClassInfoDto (班级信息DTO)

**文件位置**: `src/main/java/com/signlab1/pojo/dto/ClassInfoDto.java`

```java
@Data
public class ClassInfoDto {
    private String classCode;            // 班级编号
    private String className;            // 班级名称
    private LocalDateTime bindTime;      // 绑定时间
}
```

---

## 功能模块

### 班级管理

#### 1. 创建班级

**功能说明**: 管理员可以创建新的班级，系统自动生成验证码。

**实现方式**: 
- 通过Excel批量导入
- 验证码自动生成（默认6位数字）

**相关代码**:
- `ExcelTestController.importClasses()` - 批量导入班级
- `ClassMapper` - 班级数据访问层

#### 2. 查询班级

**功能说明**: 支持按班级编号、班级名称查询班级信息。

**相关代码**:
- `ClassMapper.selectList()` - 查询班级列表
- `ClassMapper.selectOne()` - 查询单个班级

#### 3. 班级验证码

**功能说明**: 每个班级有唯一的验证码，用于学生绑定班级。

**验证码规则**:
- 长度：10位
- 格式：6位数字
- 唯一性：全校唯一

---

### 学生班级关联

#### 1. 绑定班级

**功能说明**: 学生通过班级验证码绑定到指定班级。

**业务逻辑**:
1. 验证学生是否存在
2. 验证班级验证码是否有效
3. 检查是否已绑定过该班级
4. 创建绑定关系并记录绑定时间

**限制条件**:
- 一个学生可以绑定多个班级
- 同一学生不能重复绑定同一班级
- 学生必须绑定至少一个班级才能签到

**相关代码**:
- `StudentService.bindClass()` - 绑定班级
- `StudentController.bindClass()` - 绑定班级接口

#### 2. 查询学生班级列表

**功能说明**: 查询学生已绑定的所有班级。

**返回信息**:
- 班级编号
- 班级名称
- 绑定时间

**相关代码**:
- `StudentService.getStudentClasses()` - 获取学生班级列表
- `StudentController.getStudentClasses()` - 查询班级列表接口

#### 3. 查询班级学生列表

**功能说明**: 查询指定班级的所有学生。

**相关代码**:
- `TeacherService.getTeacherClassStudents()` - 获取班级学生
- `TeacherController.getClassStudents()` - 查询班级学生接口

---

### 签到管理

#### 1. 智能签到

**功能说明**: 学生扫描二维码进行签到，系统自动识别学生所属班级。

**签到逻辑**:
1. 解析二维码内容（课程ID、教师、班级、时间戳）
2. 验证二维码时效性（30秒有效期）
3. 智能判断签到类型：
   - **本班签到**: 学生有该老师同一时间的课程，记录到自己的课程
   - **跨班签到**: 学生没有该老师同一时间的课程，记录为跨班签到
4. 检查是否已签到
5. 创建签到记录

**跨班签到规则**:
- 学生必须绑定至少一个班级
- 签到记录保存到学生自己的课程中
- 系统记录跨班签到标记

**相关代码**:
- `StudentService.scanAttendance()` - 扫码签到
- `StudentController.scanAttendance()` - 签到接口

#### 2. 查询签到记录

**功能说明**: 查询学生的签到历史记录。

**返回信息**:
- 课程信息（课程名称、教师、地点）
- 签到时间
- 签到状态

**相关代码**:
- `StudentService.getAttendanceRecords()` - 获取签到记录
- `StudentController.getAttendanceRecords()` - 查询签到记录接口

#### 3. 签到统计

**功能说明**: 统计学生的签到情况。

**统计指标**:
- 总签到次数
- 签到率

**相关代码**:
- `StudentService.getAttendanceStats()` - 获取签到统计
- `StudentController.getAttendanceStats()` - 签到统计接口

#### 4. 查看课程签到情况（教师端）

**功能说明**: 教师查看课程的签到详情。

**返回信息**:
- 学生列表
- 每个学生的签到状态
- 签到时间

**相关代码**:
- `TeacherService.getCourseAttendance()` - 获取课程签到情况
- `TeacherController.getCourseAttendance()` - 查看签到接口

#### 5. 修改签到状态

**功能说明**: 教师可以手动修改学生的签到状态。

**操作类型**:
- 标记为已签到
- 标记为未签到

**相关代码**:
- `TeacherService.updateStudentAttendance()` - 修改签到状态
- `TeacherController.updateStudentAttendance()` - 修改签到接口

---

### 课堂照片

#### 1. 上传课堂照片

**功能说明**: 学生可以上传课堂照片。

**上传流程**:
1. 验证课程是否存在
2. 上传文件到服务器
3. 保存照片记录到数据库
4. 返回照片访问URL

**文件存储路径**: `uploads/signlab/photos/{年份}/{月份}/{日期}/{课程ID}/`

**支持格式**: JPG, PNG, GIF, WEBP

**相关代码**:
- `StudentService.uploadClassPhoto()` - 上传照片
- `StudentController.uploadClassPhoto()` - 上传接口

#### 2. 查询课堂照片

**功能说明**: 查询已上传的课堂照片。

**查询维度**:
- 按学生查询
- 按课程查询
- 按学生和课程组合查询

**返回信息**:
- 照片ID
- 照片URL
- 学生信息
- 课程信息
- 上传时间
- 文件大小
- 备注

**相关代码**:
- `StudentService.getStudentPhotos()` - 获取学生照片列表
- `StudentService.getStudentPhotosByCourse()` - 按课程获取照片
- `TeacherService.getCoursePhotos()` - 获取课程照片（教师端）
- `StudentController.getStudentPhotos()` - 查询接口

#### 3. 删除课堂照片

**功能说明**: 学生可以删除自己上传的照片。

**权限控制**:
- 只能删除自己的照片
- 教师可以删除课程的所有照片

**相关代码**:
- `StudentService.deleteClassPhoto()` - 删除照片
- `StudentController.deleteClassPhoto()` - 删除接口

#### 4. 查看照片

**功能说明**: 通过照片ID查看照片详情。

**相关代码**:
- `PublicController.getPhotoById()` - 查看照片接口

---

### 多班级课程

#### 1. 配置多班级课程

**功能说明**: 教师可以将一个课程配置为面向多个班级。

**配置流程**:
1. 验证课程是否存在
2. 验证教师权限
3. 删除现有配置
4. 添加新的多班级配置

**使用场景**:
- 同一老师同时给多个班级上课
- 合班上课

**相关代码**:
- `TeacherService.configureMultiClassCourse()` - 配置多班级课程
- `TeacherController.configureMultiClassCourse()` - 配置接口

#### 2. 查询多班级课程信息

**功能说明**: 查询课程的多班级配置信息。

**返回信息**:
- 课程基本信息
- 教师信息
- 关联的班级列表
- 是否为多班级课程

**相关代码**:
- `TeacherService.getMultiClassCourseInfo()` - 获取多班级课程信息
- `TeacherController.getMultiClassCourseInfo()` - 查询接口

#### 3. 删除多班级配置

**功能说明**: 删除课程的多班级配置。

**相关代码**:
- `TeacherService.deleteMultiClassCourse()` - 删除配置
- `TeacherController.deleteMultiClassCourse()` - 删除接口

#### 4. 生成通用签到二维码

**功能说明**: 为多班级课程生成通用签到二维码。

**特点**:
- 同一老师同一时间的多个班级可以使用同一个二维码
- 学生扫码后自动识别到自己的课程

**相关代码**:
- `TeacherService.generateUniversalAttendanceQr()` - 生成通用二维码
- `TeacherController.generateUniversalAttendanceQr()` - 生成接口

---

## API接口文档

### 学生端接口

#### 1. 绑定班级

**接口地址**: `POST /api/student/bind-class`

**请求参数**:
```json
{
  "verificationCode": "123456"
}
```

**响应示例**:
```json
{
  "code": 200,
  "message": "绑定班级成功",
  "data": null
}
```

**错误码**:
- 400: 学生不存在
- 400: 班级验证码无效
- 400: 已绑定过该班级

#### 2. 查询班级列表

**接口地址**: `GET /api/student/classes`

**响应示例**:
```json
{
  "code": 200,
  "message": "获取班级列表成功",
  "data": [
    {
      "classCode": "CS101",
      "className": "计算机科学1班",
      "bindTime": "2025-09-01T10:00:00"
    }
  ]
}
```

#### 3. 扫码签到

**接口地址**: `POST /api/student/attendance/scan`

**请求参数**:
```json
{
  "qrData": "courseId=CS001&teacherCode=T001&classCode=CS101&timestamp=1699999999"
}
```

**响应示例**:
```json
{
  "code": 200,
  "message": "签到成功！",
  "data": {
    "courseName": "数据结构",
    "teacherName": "张老师",
    "attendanceTime": "2025-09-30T10:30:00",
    "location": "实验楼301",
    "message": "签到成功！"
  }
}
```

**错误码**:
- 400: 二维码已过期
- 400: 课程不存在
- 400: 已签到过
- 400: 尚未绑定班级

#### 4. 查询签到记录

**接口地址**: `GET /api/student/attendance/records`

**响应示例**:
```json
{
  "code": 200,
  "message": "查询成功",
  "data": [
    {
      "courseId": "CS001",
      "courseName": "数据结构",
      "teacherName": "张老师",
      "location": "实验楼301",
      "attendanceTime": "2025-09-30T10:30:00",
      "status": 1
    }
  ]
}
```

#### 5. 签到统计

**接口地址**: `GET /api/student/attendance/stats`

**响应示例**:
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "totalAttendance": 10,
    "attendanceRate": 100.0
  }
}
```

#### 6. 上传课堂照片

**接口地址**: `POST /api/student/photo/upload`

**请求参数**:
- `courseId`: 课程ID
- `file`: 照片文件
- `remark`: 备注（可选）

**响应示例**:
```json
{
  "code": 200,
  "message": "上传成功",
  "data": {
    "photoId": 1,
    "photoName": "photo_001.jpg",
    "photoUrl": "/api/public/photo/1",
    "fileSize": 1024000,
    "uploadTime": "2025-09-30T10:35:00",
    "remark": "课堂笔记"
  }
}
```

#### 7. 查询课堂照片

**接口地址**: `GET /api/student/photos`

**响应示例**:
```json
{
  "code": 200,
  "message": "查询成功",
  "data": [
    {
      "id": 1,
      "courseId": "CS001",
      "courseName": "数据结构",
      "studentUsername": "2021001",
      "studentName": "张三",
      "photoName": "photo_001.jpg",
      "photoUrl": "/api/public/photo/1",
      "remark": "课堂笔记",
      "fileSize": 1024000,
      "uploadTime": "2025-09-30T10:35:00"
    }
  ]
}
```

#### 8. 按课程查询照片

**接口地址**: `GET /api/student/photos/course/{courseId}`

**响应示例**: 同上

#### 9. 删除课堂照片

**接口地址**: `DELETE /api/student/photo/{photoId}`

**响应示例**:
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

---

### 教师端接口

#### 1. 查询班级学生

**接口地址**: `GET /api/teacher/class-students`

**响应示例**:
```json
{
  "code": 200,
  "message": "查询成功",
  "data": [
    {
      "studentCode": "2021001",
      "studentName": "张三",
      "classCode": "CS101",
      "className": "计算机科学1班",
      "studentType": "CLASS_STUDENT",
      "lastAttendanceTime": "2025-09-30T10:30:00"
    }
  ]
}
```

#### 2. 查询跨班签到学生

**接口地址**: `GET /api/teacher/cross-class-attendees`

**响应示例**:
```json
{
  "code": 200,
  "message": "查询成功",
  "data": [
    {
      "studentCode": "2021002",
      "studentName": "李四",
      "classCode": "CS102",
      "className": "计算机科学2班",
      "studentType": "CROSS_CLASS_ATTENDEE",
      "lastAttendanceTime": "2025-09-30T10:32:00"
    }
  ]
}
```

#### 3. 查询学生列表（支持过滤）

**接口地址**: `GET /api/teacher/students`

**请求参数**:
- `classCode`: 班级代码（可选）
- `studentType`: 学生类型（可选：CLASS_STUDENT, CROSS_CLASS_ATTENDEE）

**响应示例**:
```json
{
  "code": 200,
  "message": "查询成功",
  "data": [
    {
      "studentCode": "2021001",
      "studentName": "张三",
      "classCode": "CS101",
      "className": "计算机科学1班",
      "studentType": "CLASS_STUDENT"
    }
  ],
  "stats": {
    "totalStudents": 50,
    "classStudentCount": 45,
    "crossClassAttendeeCount": 5,
    "attendedCount": 40,
    "attendanceRate": 88.89
  }
}
```

#### 4. 查看课程签到情况

**接口地址**: `GET /api/teacher/course/{courseId}/attendance`

**响应示例**:
```json
{
  "code": 200,
  "message": "查询成功",
  "data": [
    {
      "studentCode": "2021001",
      "studentName": "张三",
      "attendanceStatus": 1,
      "attendanceTime": "2025-09-30T10:30:00"
    }
  ]
}
```

#### 5. 修改签到状态

**接口地址**: `PUT /api/teacher/course/{courseId}/attendance/{studentCode}`

**请求参数**:
```json
{
  "status": 1
}
```

**响应示例**:
```json
{
  "code": 200,
  "message": "修改成功",
  "data": null
}
```

#### 6. 获取课程照片

**接口地址**: `GET /api/teacher/course/{courseId}/photos`

**请求参数**:
- `studentUsername`: 学生用户名（可选，用于过滤特定学生的照片）

**响应示例**:
```json
{
  "code": 200,
  "message": "查询成功",
  "data": [
    {
      "id": 1,
      "courseId": "CS001",
      "courseName": "数据结构",
      "studentUsername": "2021001",
      "studentName": "张三",
      "photoName": "photo_001.jpg",
      "photoUrl": "/api/student/photo/1",
      "remark": "课堂笔记",
      "fileSize": 1024000,
      "uploadTime": "2025-09-30T10:35:00"
    }
  ]
}
```

#### 7. 配置多班级课程

**接口地址**: `POST /api/teacher/multi-class/configure`

**请求参数**:
```json
{
  "courseId": "CS001",
  "teacherUsername": "T001",
  "classCodes": ["CS101", "CS102", "CS103"]
}
```

**响应示例**:
```json
{
  "code": 200,
  "message": "配置成功",
  "data": null
}
```

#### 8. 查询多班级课程信息

**接口地址**: `GET /api/teacher/multi-class/info/{courseId}`

**响应示例**:
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "courseId": "CS001",
    "courseName": "数据结构",
    "teacherName": "张老师",
    "isMultiClass": true,
    "classes": [
      {
        "classCode": "CS101",
        "className": "计算机科学1班"
      },
      {
        "classCode": "CS102",
        "className": "计算机科学2班"
      }
    ]
  }
}
```

#### 9. 删除多班级配置

**接口地址**: `DELETE /api/teacher/multi-class/{courseId}`

**响应示例**:
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

#### 10. 生成通用签到二维码

**接口地址**: `GET /api/teacher/course/{courseId}/universal-qr`

**响应示例**:
```json
{
  "code": 200,
  "message": "生成成功",
  "data": {
    "qrContent": "courseId=CS001&teacherUsername=T001&timestamp=1699999999",
    "qrImage": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA...",
    "courseId": "CS001",
    "timestamp": 1699999999,
    "remainingTime": 30
  }
}
```

---

### 管理员接口

#### 1. 批量导入班级

**接口地址**: `POST /api/test/excel/import/classes`

**文件要求**:
- 文件名: `classes.xls` 或 `classes.xlsx`
- 位置: 项目根目录
- 格式: Excel表格

**字段映射**:
- Cell[0]: id（跳过）
- Cell[1]: classCode（班级编号）
- Cell[2]: className（班级名称）
- Cell[3]: studentCount（班级人数）

**响应示例**:
```json
{
  "code": 200,
  "message": "导入完成！成功：10条，重复：0条，失败：0条，耗时：1500ms",
  "data": null
}
```

#### 2. 批量导入学生班级关联

**接口地址**: `POST /api/test/excel/import/student-class-relations`

**文件要求**:
- 文件名: `student_class_relations.xls` 或 `student_class_relations.xlsx`
- 位置: 项目根目录

**字段映射**:
- Cell[0]: id（跳过）
- Cell[1]: studentUsername（学生用户名）
- Cell[2]: classCode（班级编号）
- Cell[3]: bindTime（绑定时间）
- Cell[4]: isDeleted（是否删除）

**响应示例**:
```json
{
  "code": 200,
  "message": "导入完成！成功：100条，失败：0条",
  "data": null
}
```

#### 3. 批量导入课堂照片

**接口地址**: `POST /api/test/excel/import/class-photos`

**文件要求**:
- 文件名: `class_photos.xls` 或 `class_photos.xlsx`
- 位置: 项目根目录

**响应示例**:
```json
{
  "code": 200,
  "message": "导入完成！成功：50条，失败：0条",
  "data": null
}
```

---

## 业务流程

### 1. 学生绑定班级流程

```
开始
  ↓
学生登录系统
  ↓
点击"绑定班级"
  ↓
输入班级验证码
  ↓
系统验证验证码
  ↓
验证通过？
  ├─ 否 → 提示"验证码无效" → 结束
  └─ 是 → 检查是否已绑定
         ↓
         已绑定？
         ├─ 是 → 提示"已绑定过该班级" → 结束
         └─ 否 → 创建绑定关系
                ↓
                提示"绑定成功" → 结束
```

### 2. 学生签到流程

```
开始
  ↓
学生扫描二维码
  ↓
系统解析二维码内容
  ↓
验证二维码时效性（30秒）
  ↓
二维码有效？
  ├─ 否 → 提示"二维码已过期" → 结束
  └─ 是 → 验证课程存在
         ↓
         课程存在？
         ├─ 否 → 提示"课程不存在" → 结束
         └─ 是 → 检查学生是否绑定班级
                ↓
                已绑定班级？
                ├─ 否 → 提示"尚未绑定班级" → 结束
                └─ 是 → 智能判断签到类型
                       ↓
                       查找学生是否有同一老师同一时间的课程
                       ↓
                       找到自己的课程？
                       ├─ 是 → 记录到自己的课程（本班签到）
                       └─ 否 → 记录为跨班签到
                              ↓
                              检查是否已签到
                              ↓
                              已签到？
                              ├─ 是 → 提示"已签到过" → 结束
                              └─ 否 → 创建签到记录
                                     ↓
                                     提示"签到成功" → 结束
```

### 3. 教师查看签到情况流程

```
开始
  ↓
教师登录系统
  ↓
选择课程
  ↓
点击"查看签到"
  ↓
系统查询班级学生列表
  ↓
查询每个学生的签到记录
  ↓
生成签到统计
  ↓
显示签到详情
  ↓
需要修改签到状态？
  ├─ 否 → 结束
  └─ 是 → 选择学生
         ↓
         修改签到状态
         ↓
         保存修改
         ↓
         提示"修改成功" → 结束
```

### 4. 多班级课程配置流程

```
开始
  ↓
教师登录系统
  ↓
选择课程
  ↓
点击"配置多班级"
  ↓
选择要关联的班级
  ↓
提交配置
  ↓
系统验证课程权限
  ↓
权限验证通过？
  ├─ 否 → 提示"无权限" → 结束
  └─ 是 → 删除现有配置
         ↓
         添加新的班级关联
         ↓
         提示"配置成功" → 结束
```

---

## 数据导入导出

### 1. Excel导入

#### 班级数据导入

**文件格式**: `classes.xls` 或 `classes.xlsx`

**字段说明**:
| 列 | 字段名 | 说明 | 必填 |
|----|--------|------|------|
| A | id | ID（跳过） | 否 |
| B | classCode | 班级编号 | 是 |
| C | className | 班级名称 | 是 |
| D | studentCount | 班级人数 | 是 |

**示例数据**:
```
id | classCode | className | studentCount
----|-----------|-----------|-------------
1  | CS101     | 计算机科学1班 | 45
2  | CS102     | 计算机科学2班 | 42
```

#### 学生班级关联导入

**文件格式**: `student_class_relations.xls` 或 `student_class_relations.xlsx`

**字段说明**:
| 列 | 字段名 | 说明 | 必填 |
|----|--------|------|------|
| A | id | ID（跳过） | 否 |
| B | studentUsername | 学生用户名 | 是 |
| C | classCode | 班级编号 | 是 |
| D | bindTime | 绑定时间 | 否 |
| E | isDeleted | 是否删除 | 否 |

**示例数据**:
```
id | studentUsername | classCode | bindTime | isDeleted
----|-----------------|-----------|----------|------------
1  | 2021001         | CS101     | 2025-09-01 | 0
2  | 2021002         | CS101     | 2025-09-01 | 0
```

### 2. Excel导出

#### 考勤记录导出

**接口地址**: `GET /api/test/excel/export/attendance`

**导出内容**:
- 按班级分组
- 包含每个学生的考勤记录
- 支持跨班签到标记

#### 课程成绩导出

**接口地址**: `GET /api/test/excel/export/grades`

**导出内容**:
- 按班级分组
- 包含每个学生的课程成绩
- 支持多班级课程合并导出

---

## 注意事项

### 1. 验证码管理

- 验证码长度为10位
- 验证码必须全校唯一
- 建议定期更换验证码
- 验证码不应包含敏感信息

### 2. 签到规则

- 二维码有效期为30秒
- 学生必须绑定至少一个班级才能签到
- 同一学生不能重复签到同一课程
- 跨班签到会自动记录到学生自己的课程

### 3. 班级关联

- 一个学生可以绑定多个班级
- 同一学生不能重复绑定同一班级
- 解绑班级不会删除签到记录
- 班级删除前应先解绑所有学生

### 4. 照片上传

- 支持的格式：JPG, PNG, GIF, WEBP
- 单个照片大小限制：10MB
- 照片存储路径按日期和课程分类
- 删除照片会同时删除物理文件

### 5. 多班级课程

- 多班级课程使用通用签到二维码
- 学生扫码后自动识别到自己的课程
- 跨班签到会记录到学生所属班级的课程
- 教师可以查看所有关联班级的签到情况

### 6. 数据安全

- 所有接口都需要JWT认证
- 学生只能查看自己的数据
- 教师只能查看自己课程的数据
- 管理员拥有所有权限

### 7. 性能优化

- 批量导入使用分批处理（每批500条）
- 查询学生列表时使用批量查询优化
- 照片访问使用缓存机制
- 签到记录按索引查询

### 8. 错误处理

- 所有接口都有统一的错误响应格式
- 错误信息会记录到日志
- 关键操作使用事务保证数据一致性
- 文件操作有异常捕获和清理机制

---

## 附录

### A. 完整字段映射表

#### Class（班级表）
| 数据库字段 | 实体类字段 | 类型 | 说明 |
|-----------|-----------|------|------|
| id | id | Long | 班级ID |
| class_code | classCode | String | 班级编号 |
| class_name | className | String | 班级名称 |
| verification_code | verificationCode | String | 验证码 |
| student_count | studentCount | Integer | 班级人数 |
| create_time | createTime | LocalDateTime | 创建时间 |
| update_time | updateTime | LocalDateTime | 更新时间 |
| is_deleted | isDeleted | Integer | 是否删除 |

#### StudentClassRelation（学生班级关联表）
| 数据库字段 | 实体类字段 | 类型 | 说明 |
|-----------|-----------|------|------|
| id | id | Long | 关联ID |
| student_username | studentUsername | String | 学生用户名 |
| class_code | classCode | String | 班级编号 |
| bind_time | bindTime | LocalDateTime | 绑定时间 |
| is_deleted | isDeleted | Integer | 是否删除 |

### B. 相关文件清单

#### 实体类
- `src/main/java/com/signlab1/pojo/entity/Class.java`
- `src/main/java/com/signlab1/pojo/entity/StudentClassRelation.java`
- `src/main/java/com/signlab1/pojo/entity/ClassPhoto.java`
- `src/main/java/com/signlab1/pojo/entity/Course.java`
- `src/main/java/com/signlab1/pojo/entity/AttendanceRecord.java`
- `src/main/java/com/signlab1/pojo/entity/MultiClassCourse.java`

#### DTO类
- `src/main/java/com/signlab1/pojo/dto/ClassInfoDto.java`
- `src/main/java/com/signlab1/pojo/dto/ClassPhotoDto.java`
- `src/main/java/com/signlab1/pojo/dto/AttendanceResultDto.java`
- `src/main/java/com/signlab1/pojo/dto/AttendanceRecordDto.java`
- `src/main/java/com/signlab1/pojo/dto/AttendanceStatsDto.java`
- `src/main/java/com/signlab1/pojo/dto/StudentInfoDto.java`
- `src/main/java/com/signlab1/pojo/dto/StudentAttendanceDto.java`

#### Service类
- `src/main/java/com/signlab1/service/StudentService.java`
- `src/main/java/com/signlab1/service/TeacherService.java`

#### Controller类
- `src/main/java/com/signlab1/controller/StudentController.java`
- `src/main/java/com/signlab1/controller/TeacherController.java`
- `src/main/java/com/signlab1/controller/ExcelTestController.java`
- `src/main/java/com/signlab1/controller/PublicController.java`

#### Mapper类
- `src/main/java/com/signlab1/mapper/ClassMapper.java`
- `src/main/java/com/signlab1/mapper/StudentClassRelationMapper.java`
- `src/main/java/com/signlab1/mapper/ClassPhotoMapper.java`

#### 数据库脚本
- `database/init.sql` - 初始化数据库表结构
- `database/add_wechat_fields.sql` - 添加微信字段

### C. 版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| 1.0.0 | 2025-09-01 | 初始版本，支持基本的班级管理和签到功能 |
| 1.1.0 | 2025-09-15 | 添加多班级课程支持 |
| 1.2.0 | 2025-09-30 | 添加跨班签到功能 |
| 1.3.0 | 2025-10-10 | 添加课堂照片功能 |
| 1.4.0 | 2025-10-20 | 优化批量导入性能 |

---

**文档版本**: 1.0.0  
**最后更新**: 2026-01-25  
**维护者**: SignLab开发团队