# 批量导入用户文档

## 概述

本项目支持通过Excel文件批量导入各类数据，包括用户、班级、课程、考勤记录、成绩等。本文档详细介绍如何使用批量导入功能。

## 支持的导入类型

| 导入类型 | API接口 | Excel文件 | 说明 |
|---------|---------|-----------|------|
| 用户数据 | `POST /api/test/excel/import/users` | users.xls / users.xlsx | 导入学生和教师账号 |
| 班级数据 | `POST /api/test/excel/import/classes` | classes.xls / classes.xlsx | 导入班级信息 |
| 课程数据 | `POST /api/test/excel/import/courses` | courses.xls / courses.xlsx | 导入课程安排 |
| 学生班级关联 | `POST /api/test/excel/import/student-class-relations` | student_class_relations.xls / student_class_relations.xlsx | 建立学生与班级的关联 |
| 考勤记录 | `POST /api/test/excel/import/attendance-records` | attendance_records.xls / attendance_records.xlsx | 导入考勤数据 |
| 课程成绩 | `POST /api/test/excel/import/course-grades` | course_grades.xls / course_grades.xlsx | 导入学生成绩 |
| 作业提交 | `POST /api/test/excel/import/assignment-submissions` | assignment_submissions.xls / assignment_submissions.xlsx | 导入作业提交记录 |

## 一、用户数据导入

### 1.1 Excel文件格式

**文件名**: `users.xls` 或 `users.xlsx`

**字段说明**:

| 列序号 | 字段名 | 类型 | 必填 | 说明 |
|-------|--------|------|------|------|
| 0 | id | Integer | 否 | 用户ID（自动生成，跳过） |
| 1 | username | String | 是 | 学号/工号（唯一标识） |
| 2 | name | String | 是 | 姓名 |
| 3 | password | String | 是 | 密码（BCrypt加密） |
| 4 | role | String | 是 | 角色（student/teacher/admin） |
| 5 | password_set | Integer | 否 | 是否已设置密码（0/1） |
| 6 | create_time | DateTime | 否 | 创建时间 |
| 7 | update_time | DateTime | 否 | 更新时间 |
| 8 | is_deleted | Integer | 否 | 是否删除（0/1） |
| 9 | wx_openid | String | 否 | 微信OpenID |
| 10 | wx_unionid | String | 否 | 微信UnionID |
| 11 | wx_nickname | String | 否 | 微信昵称 |
| 12 | wx_avatar | String | 否 | 微信头像URL |
| 13 | wx_bind_time | DateTime | 否 | 微信绑定时间 |

### 1.2 示例数据

```
username    | name    | password              | role     | password_set | wx_openid | wx_nickname
-----------|---------|-----------------------|----------|--------------|-----------|-------------
00005642   | 梁祖红  | $2a$10$dY.NO/SisiF... | teacher  | 1            |           |
2112503179 | 王琛    | $2a$10$G9V2O4ZcW...  | student  | 1            |           |
```

### 1.3 密码生成规则

- **学生**: 默认密码为学号
- **教师**: 默认密码为 `syjx@` + 工号后四位

例如：
- 教师工号 `00006140` → 密码 `syjx@6140`
- 学生学号 `2112503179` → 密码 `2112503179`

导入前需要使用BCrypt加密密码。

### 1.4 导入步骤

1. **准备Excel文件**
   - 确保 `users.xls` 或 `users.xlsx` 文件位于项目根目录
   - 第一行为标题行，从第二行开始为数据
   - 确保必填字段（username, name, password, role）都有值

2. **调用API接口**
   ```bash
   POST http://localhost:8080/api/test/excel/import/users
   ```

3. **查看导入结果**
   - API返回导入统计信息
   - 详细日志输出到控制台

### 1.5 导入响应示例

```json
{
  "code": 200,
  "message": "导入完成！成功：500条，重复：0条，失败：2条，耗时：1500ms",
  "data": null
}
```

### 1.6 注意事项

- **username唯一性**: 学号/工号必须唯一，重复会导致导入失败
- **role规范**: 只能是 `student`、`teacher` 或 `admin`
- **密码加密**: 密码必须使用BCrypt加密后才能导入
- **文件位置**: Excel文件必须放在项目根目录下
- **批量大小**: 每批插入500条记录，大数据量会自动分批处理

## 二、班级数据导入

### 2.1 Excel文件格式

**文件名**: `classes.xls` 或 `classes.xlsx`

**字段说明**:

| 列序号 | 字段名 | 类型 | 必填 | 说明 |
|-------|--------|------|------|------|
| 0 | id | Integer | 否 | 班级ID（自动生成） |
| 1 | class_code | String | 是 | 班级编号（唯一） |
| 2 | class_name | String | 是 | 班级名称 |
| 3 | student_count | Integer | 是 | 班级人数 |

### 2.2 示例数据

```
class_code      | class_name      | student_count
----------------|-----------------|---------------
工程实践B01     | 工程实践B01班   | 41
工程实践B02     | 工程实践B02班   | 42
```

### 2.3 导入步骤

1. 准备 `classes.xls` 文件
2. 调用API: `POST /api/test/excel/import/classes`
3. 查看导入结果

## 三、课程数据导入

### 3.1 Excel文件格式

**文件名**: `courses.xls` 或 `courses.xlsx`

**字段说明**:

| 列序号 | 字段名 | 类型 | 必填 | 说明 |
|-------|--------|------|------|------|
| 0 | id | Integer | 否 | 课程ID（自动生成） |
| 1 | course_id | String | 是 | 课程编号 |
| 2 | course_name | String | 是 | 课程名称 |
| 3 | teacher_username | String | 是 | 教师工号 |
| 4 | class_code | String | 是 | 班级编号 |
| 5 | location | String | 是 | 上课地点 |
| 6 | course_date | String | 是 | 上课日期（格式：MM/dd/yy） |
| 7 | time_slot | String | 是 | 时间段 |

### 3.2 日期格式说明

Excel中的日期格式为 `MM/dd/yy`，例如：
- `10/14/25` → 2025年10月14日
- `9/30/25` → 2025年9月30日

系统会自动转换为 `yyyy-MM-dd` 格式。

### 3.3 时间段说明

- `上午` → 08:30-12:00
- `下午` → 14:40-18:05

### 3.4 示例数据

```
course_id | course_name | teacher_username | class_code  | location    | course_date | time_slot
----------|-------------|------------------|-------------|-------------|-------------|----------
CS101     | 工程实践    | 00006140         | 工程实践B01  | 实验4-215   | 9/30/25     | 上午
CS102     | 物理2       | 00006366         | 工程实践B01  | 实验4-510   | 10/14/25    | 上午
```

## 四、学生班级关联导入

### 4.1 Excel文件格式

**文件名**: `student_class_relations.xls` 或 `student_class_relations.xlsx`

**字段说明**:

| 列序号 | 字段名 | 类型 | 必填 | 说明 |
|-------|--------|------|------|------|
| 0 | id | Integer | 否 | 关联ID（自动生成） |
| 1 | student_username | String | 是 | 学生学号 |
| 2 | class_code | String | 是 | 班级编号 |
| 3 | bind_time | DateTime | 否 | 绑定时间 |
| 4 | is_deleted | Integer | 否 | 是否删除（0/1） |

### 4.2 示例数据

```
student_username | class_code  | bind_time
-----------------|-------------|-----------
2112503179       | 工程实践B01  | 2025-09-29 23:12:23
2112503180       | 工程实践B01  | 2025-09-29 23:12:23
```

## 五、考勤记录导入

### 5.1 Excel文件格式

**文件名**: `attendance_records.xls` 或 `attendance_records.xlsx`

**字段说明**:

| 列序号 | 字段名 | 类型 | 必填 | 说明 |
|-------|--------|------|------|------|
| 0 | id | Integer | 否 | 记录ID（自动生成） |
| 1 | course_id | String | 是 | 课程编号 |
| 2 | student_username | String | 是 | 学生学号 |
| 3 | attendance_time | DateTime | 是 | 考勤时间 |
| 4 | attendance_status | String | 是 | 考勤状态 |
| 5 | ip_address | String | 否 | IP地址 |
| 6 | create_time | DateTime | 否 | 创建时间 |
| 7 | update_time | DateTime | 否 | 更新时间 |
| 8 | is_deleted | Integer | 否 | 是否删除（0/1） |

### 5.2 考勤状态

- `present` - 出勤
- `absent` - 缺勤
- `late` - 迟到
- `leave` - 请假

### 5.3 示例数据

```
course_id | student_username | attendance_time        | attendance_status | ip_address
----------|------------------|------------------------|-------------------|------------
CS101     | 2112503179       | 2025-09-30 08:30:00   | present           | 192.168.1.100
CS101     | 2112503180       | 2025-09-30 08:35:00   | late              | 192.168.1.101
```

## 六、课程成绩导入

### 6.1 Excel文件格式

**文件名**: `course_grades.xls` 或 `course_grades.xlsx`

**字段说明**:

| 列序号 | 字段名 | 类型 | 必填 | 说明 |
|-------|--------|------|------|------|
| 0 | id | Integer | 否 | 成绩ID（自动生成） |
| 1 | student_username | String | 是 | 学生学号 |
| 2 | course_id | String | 是 | 课程编号 |
| 3 | grade | String | 是 | 成绩 |
| 4 | teacher_username | String | 是 | 教师工号 |
| 5 | teacher_comment | String | 否 | 教师评语 |

### 6.2 示例数据

```
student_username | course_id | grade | teacher_username | teacher_comment
-----------------|-----------|-------|------------------|------------------
2112503179       | CS101     | 90    | 00006140         | 表现优秀
2112503180       | CS101     | 85    | 00006140         | 良好
```

## 七、作业提交导入

### 7.1 Excel文件格式

**文件名**: `assignment_submissions.xls` 或 `assignment_submissions.xlsx`

**字段说明**:

| 列序号 | 字段名 | 类型 | 必填 | 说明 |
|-------|--------|------|------|------|
| 0 | id | Integer | 否 | 提交ID（自动生成） |
| 1 | student_username | String | 是 | 学生学号 |
| 2 | course_id | String | 是 | 课程编号 |
| 3 | submission_type | String | 是 | 提交类型 |
| 4 | file_path | String | 是 | 文件路径 |
| 5 | submission_status | String | 是 | 提交状态 |

### 7.2 示例数据

```
student_username | course_id | submission_type | file_path                              | submission_status
-----------------|-----------|-----------------|----------------------------------------|------------------
2112503179       | CS101     | 实验报告        | uploads/assignments/report_001.pdf    | submitted
2112503180       | CS101     | 实验报告        | uploads/assignments/report_002.pdf    | submitted
```

## 八、课程模板导入（简化版）

### 8.1 Excel文件格式

**文件名**: `course_template.xlsx`

**字段说明**:

| 列序号 | 字段名 | 类型 | 必填 | 说明 |
|-------|--------|------|------|------|
| 0 | 班级 | String | 是 | 班级名称 |
| 1 | 人数 | Integer | 是 | 班级人数 |
| 2 | 课程 | String | 是 | 主课程名称 |
| 3 | 实验 | String | 是 | 实际课程名称 |
| 4 | 工号 | String | 是 | 教师工号 |
| 5 | 任课教师 | String | 是 | 教师姓名 |
| 6 | 上课时间 | String | 是 | 上课时间（如：9月30日上午） |
| 7 | 上课地点 | String | 是 | 上课地点 |

### 8.2 示例数据

```
班级        | 人数 | 课程     | 实验       | 工号      | 任课教师 | 上课时间     | 上课地点
------------|------|----------|------------|-----------|----------|--------------|----------
工程实践B01  | 41   | 工程实践 | 工程导论课 | 00006140  | 谢小柱   | 9月30日上午  | 实验4-215
工程实践B01  | 41   | 工程实践 | 物理2      | 00006366  | 庞玮     | 10月14日上午 | 实验4-510
```

### 8.3 特殊说明

- 使用此模板时，系统会自动：
  - 创建或查找对应的班级
  - 创建教师账号（如果不存在）
  - 创建课程记录
  - 生成验证码
- 教师密码自动生成为 `syjx@` + 工号后四位

## 九、导入流程最佳实践

### 9.1 推荐导入顺序

1. **导入用户数据**（users.xls）
   - 先导入所有教师和学生账号

2. **导入班级数据**（classes.xls）
   - 创建班级信息

3. **导入课程数据**（courses.xls）
   - 创建课程安排

4. **导入学生班级关联**（student_class_relations.xls）
   - 建立学生与班级的关系

5. **导入其他数据**
   - 考勤记录、成绩、作业等

### 9.2 数据验证

导入前请确保：
- ✅ Excel文件格式正确，包含所有必填字段
- ✅ 用户名（学号/工号）唯一且已存在
- ✅ 班级编号在班级表中存在
- ✅ 课程编号在课程表中存在
- ✅ 教师工号在用户表中存在
- ✅ 学生学号在用户表中存在

### 9.3 错误处理

导入过程中如果出现错误：
1. 检查日志输出，定位错误行
2. 验证数据格式是否符合要求
3. 确认关联数据（班级、课程、用户）已存在
4. 修正数据后重新导入

### 9.4 性能优化

- 批量大小默认为500条
- 支持大规模数据导入
- 建议单次导入不超过10,000条

## 十、密码加密工具

### 10.1 BCrypt加密

密码必须使用BCrypt加密后才能导入。可以使用以下方法生成加密密码：

```java
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;

public class PasswordGenerator {
    public static void main(String[] args) {
        BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
        String rawPassword = "2112503179"; // 学号或工号
        String encodedPassword = encoder.encode(rawPassword);
        System.out.println(encodedPassword);
    }
}
```

### 10.2 批量生成加密密码

可以使用项目提供的 `PasswordGenerator.class` 工具：

```bash
java PasswordGenerator
```

## 十一、API调用示例

### 11.1 使用cURL

```bash
# 导入用户
curl -X POST http://localhost:8080/api/test/excel/import/users

# 导入班级
curl -X POST http://localhost:8080/api/test/excel/import/classes

# 导入课程
curl -X POST http://localhost:8080/api/test/excel/import/courses
```

### 11.2 使用Postman

1. 创建新的POST请求
2. URL: `http://localhost:8080/api/test/excel/import/users`
3. 点击Send
4. 查看响应结果

## 十二、常见问题

### Q1: 导入失败，提示"文件不存在"

**A**: 确保Excel文件放在项目根目录下，文件名正确。

### Q2: 导入失败，提示"字段映射错误"

**A**: 检查Excel文件的列顺序是否与文档说明一致。

### Q3: 导入成功但数据未显示

**A**: 检查数据库连接，确认数据已正确插入。

### Q4: 如何批量生成加密密码？

**A**: 使用 `PasswordGenerator` 工具或编写批量处理脚本。

### Q5: 导入时提示"重复数据"

**A**: 检查是否有重复的用户名、班级编号等唯一字段。

## 十三、技术实现细节

### 13.1 批量插入

系统使用MyBatis-Plus的批量插入功能：

```java
private int batchInsertUsers(List<User> userList) {
    int successCount = 0;
    for (int i = 0; i < userList.size(); i += BATCH_SIZE) {
        int end = Math.min(i + BATCH_SIZE, userList.size());
        List<User> batch = userList.subList(i, end);
        int inserted = userMapper.insertBatchSomeColumn(batch);
        successCount += inserted;
    }
    return successCount;
}
```

### 13.2 日期格式处理

系统支持多种日期格式，自动转换为标准格式：

```java
DateTimeFormatter formatter = new DateTimeFormatterBuilder()
    .appendPattern("M/d/yy")
    .toFormatter();
```

### 13.3 错误处理

每条记录独立处理，单条失败不影响其他记录：

```java
try {
    // 处理单条记录
} catch (Exception e) {
    errorCount++;
    log.error("解析第{}行数据失败: {}", i + 1, e.getMessage());
}
```

## 十四、附录

### 14.1 完整字段映射表

| 导入类型 | Excel文件 | 字段数量 | 批量大小 |
|---------|-----------|---------|---------|
| 用户数据 | users.xls | 14 | 500 |
| 班级数据 | classes.xls | 4 | 500 |
| 课程数据 | courses.xls | 8 | 500 |
| 学生班级关联 | student_class_relations.xls | 5 | 500 |
| 考勤记录 | attendance_records.xls | 9 | 500 |
| 课程成绩 | course_grades.xls | 6 | 500 |
| 作业提交 | assignment_submissions.xls | 6 | 500 |

### 14.2 数据库表结构

- `users` - 用户表
- `classes` - 班级表
- `courses` - 课程表
- `student_class_relations` - 学生班级关联表
- `attendance_records` - 考勤记录表
- `course_grades` - 课程成绩表
- `assignment_submissions` - 作业提交表

### 14.3 相关文件

- `ExcelTestController.java` - 导入控制器
- `UserMapper.java` - 用户数据访问
- `ClassMapper.java` - 班级数据访问
- `CourseMapper.java` - 课程数据访问

## 联系支持

如有问题，请联系技术支持或查看项目文档。